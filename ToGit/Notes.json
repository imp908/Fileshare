

//Links
[
//tfs
http://msk1-vm-tfs01.nspk.ru:8080/tfs/DefaultCollection/_versionControl?path=%24%2FNSPK%20DevTeam%2FOVISPO%20MD%2Findex.md&_a=compare
//Jira
http://jira.nspk.ru
//Address book
http://my.nspk.ru/
http://my.nspk.ru/chart/
//Helpdesk
http://help.nspk.ru/Task
//orientDB admin
http://msk1-vm-ovisp02:2480/studio/index.html#/database/news_test2/functions
//orientDB test
http://msk1-vm-ovisp02:2480/studio/index.html#/database/news_test1
//orientDB copy
http://msk1-vm-ovisp02:2480/studio/index.html#/database/news_test3
//Orient FUNCTIONS for API
https://orientdb.com/docs/2.2/Functions-DB-Access.html
//Orient prod
10.31.25.155:2424 OrientDB Front2
//Orient prod
http://msk1-vm-indb01
//not prod
http://msk1-vm-indb02
//news deploy
http://msk1-vm-ovisp01



OrientDb exportimport
connect plocal:C:/OrientDB/databases/news_test* root I9grekVmk5g

DFAULT:
console.bat
connect remote:127.0.0.1/news_test* root I9grekVmk5g
import database C:/import/news_test*.gz

//restore from backup
restore database C:/backup/news_test2.zip

alter database validation false
import database C:/import/news_test*.gz -preserveClusterIDs=true -deleteRIDMapping=false
alter database validation true

in orient parent folder
import database C:/OrientDB/bin/import/news_test2.gz
DROP DATABASE PLOCAL:/orientdb/databases/news_test4 root i9grekVmk5g

sh C:/OrientDB/bin/backup.sh plocal:/127.0.0.1/database/news_test2 root I9grekVmk5g C:/export/bck.zip

release DB
https://github.com/orientechnologies/orientdb/issues/4484

connect remote:127.0.0.1/news_test2 root I9grekVmk5g
connect remote:127.0.0.1/news_test3 root I9grekVmk5g

]

//Description
[



Кратко:
===========================================

-------------------------------------------
Batch_1C_Orientdb ->
{
Прод. Версия my.nspk.ru, проект POST используестя для наполнения данными новой базы, если такая возможность возникает. Проект PUT скомпилирован в .exe приложение, которео 
по расписанию запускается на msk1-vm-inapp01 для поддержания адресной книги в актуальном состоянии
}
	содержит основные комманды и методы по работе с Orient.
	OrientClassesHelper через OrientREST кидает собранный batch query, к URL.
	десереализует orient JSON response непосредственно в POCO класс моделей, без форматирования JSON,
	И возвращает коллекцию объектов модели.
	POST инициализирует объекты Orient, заливает первоначальные данные.
	PUT тянет с 1C, привеодит из объектов к 1С в комманды к orientDB, проверяет актуальность по AD апдейтит/добавляет(отсутсвтующих в апдейт листе) в Orient.
ActiveDirectoryOrientDbEtl ->
{
для отчетов по скуду. По крайней мере эта его часть не используется, т.к. не актуально
}
	тянет работников Person с сервиса 1C тем же способом как и в Batch_1C_Orientdb. Названия Edge, странные, но посмотреть, не конфиг ли это нельзя,
	на сервис OCreate нет ссылки.
	заливает в SQLserver msk1-vm-ovisp01 SKUD. Приведение типов через через dynamic, есть модель POCO для всех иточников.
	Helper ExcelToDb содержит заливку данных из Excel через ExcelReaderFactory в базу SKUD, чтением xml схемы, наполнением Datarow иприведением
	к объекту Модели, с дальнейшей загрузкой в базу. сначала первый файл (Floor,event,location), затем второй(Visitor) из зардкод Excel.
	Добавление везде закоменчено.
	AdHelper, чето нигде не используется.
ADBook_API ->
{
будет использоваться для News
будет использоваться в адресной книге позже. Пока не располагается нигде
}
	Формирование списка из хешей SHA512 (в Batch_1C_Orientdb MD5) файлов. Сравнение хеш входящего потока и существующих в папке файлов.
	Переразмеривание картинок, архивирование.
AddressBook_News ->
{
orientDB test: http://msk1-vm-ovisp02:2480/studio/index.html#/database/news_test(4)
orientDB prod: http://msk1-vm-indb01
build deploy: http://msk1-vm-ovisp01
newstest: http://msk1-vm-ovisp01:8081/api/News/Person
newstest2: http://msk1-vm-ovisp01:8083/api/News/Person
result: http://my.nspk.ru/
Это дев. Версия будущего нашего внутреннего портала. Здесь будет реализована работа с новостями, форумами, статьями, блогами и проч. 
Пока располагается на ovisp01, на нормальном IIS сервере и там его можно потестить
}
	Тянется к Orient возвращает строки результатов.
	абстракция с шаблонами команд к базе CRUD в OrientNews (через BatchBuiler строит OrientBatch ), часть комманд c бизнеслогикой в OrientNewsHelper.
AddressBook_backend ->
{
Саша утверждает, что это используется для возврата фотографий и при ее отсутствии – дефолтной картинки. Если Саша прав, то это используется для прома адресной книги и 
располалагестя на ovisp01
}
	Авторизуется в OrientdDb, возвращает фотку из url от почты.
Intranet ->
{
Ныне ушедшего из нспк Сереги Сидельникова работа – это опросник Quiz, который используется все еще в компании. И старая версия новостей, которая была переписана полностью 
в проекте AddressBook_News
}
	MVC под что-то похожее на http://list.nspk.ru/monh/
	в IntranetHelper генерик абстракция с методами репозитория, для работы с базой.
	ValidateAtLeastOneCheckedAttribute custom validation attribute
	Несколько POCO для Quiz, Result, Question, News.
	Взаимодействие с Orient через дравйвер. ДесериализацияJSON в POCO классы моделей.
	CRUD частичной подстановкой комманд через хелперы
AccessGateRequestAutomation ->
{Распологается в ОПКЦ  сегменте. (dc01-agwusr01.win.nspk.ru)
Требуется для завеления учетных записей из заявки Банков в домен  Шлюза Доступа.( ТРХ \ СИОМ \ Диспут)}
	FTPHelper использует fluentFTP, но на часть методов нигде нет ссылок. Загружает список с файла excel, парсится IXlsReader
	ADHelper так сказать CRUD для AD. Путь к списку заявителей из excel, и параметры пользователя с привилегиями тянет с конфигов.
	Ищет, создает, удаляет, права, группы, OU,
	ConsoleProcessorXLSData обертка вокруг ADHelper, с логированием, успешные резултаты через FileResultHelper имплементацию IResult пишутся в файл.
NoificationToRadio ->
{
Ежедневная выгрузка списка сотрудников с логинами для подрядчика, который процессит корпоративное радио. Располагается на ovisp01
}
рассылка на другой адресс чем в LOR	
	
	
	
проекты, которые скорее, похожи, на концепции:
-------------------------------------------	
LOR ->
{
archive
}
	POC для рассылки запроса к MSK1-VM-INTER01 Database=is4_32_5, распарсенного через datatable в html таблицу, через exchange.
HomebrewMainDev ->
{
Сашины какие-то изыскания в коде, нигде не используется, хранится должно в архиве скриптов
archive
}
	шифрование
cmdb ->
{
archive
}
	проверка концепций OrientDb и VMwareVim в одну строчку.
OADimport ->
{
Сашины наработки с прошлой работы, который мы используем в других проектах за основу обращения к AD. В архив скриптов как пример
archive
}
	POC обращения к AD через LDAP.
OrientDriver ->
{
Не используется, предпочтение отдано REST запросам, примеров которых куча в актуальных проектах, из которых самый актуальный на данный момент это AddressBook_News
}
	исходник драйвера Orient
	OrientConsole закомменченные методы работы с базой через драйвер
Сreate_Unit_Unit_Edge ->
{
Старьё, на основе которого строились актуальные нормальные проекты. Создавался как альтернатива драйверу Orient. Больше не используется, в треш
}
	не собирается чего то, но нутри проверка коннекта к Orient

	
	
Полно:
===========================================

Непонятки
-------------------------------------------
>>
ADBook_API -> FileHelper AddFile( ...compressing )
: if compressing {  выполнть проверку и охранить архив} ?
в коде поток сравнивается с неархиваированными, архивируется и добавляется к хешу, хэш от архива не проверяется.
а в предыдущем блоке .zip -> ищется хешь архива.
Какая имено логика предполагается при проверке потока для разных форматов?
Из кода предполагаю так:
if(picture) - > if(!checkhash){resize();save();moveToHashFolder();addHash();;}
if(.zip) - > if(!checkhashForCompressed)){save();moveToHashFolder();addHash();}
if(.zip,compressed=true) - > if(!checkhashForNOTCompressed){Compress();save();moveToHashFolder();addHash();}
if(.zip,compressed=false) - > if(!checkhashForNOTCompressed){save();moveToHashFolder();addHash();}

>>
ADBook_API.Controllers -> не понятно, как в контроллер попадают файлы, т.е. почему только поток, ведь если пользователю выкидывается окошко с
FileBrowser, удобнее всего получить сразу коллекцию файлов ччерез IEnumerable<HttpPostedFileBase>.

>>
Batch_1C_Orientdb.Intranet_POST.OneSHelper.GetData()
не осознал вот этот кусок:

foreach (int data in Enum.GetValues(typeof(OneSData)))
switch (data)
{
	case (int)OneSData.Person:
		oneSDbSet.Persons.AddRange(GetDataFromOneS(DataHelper.GetStringValue((OneSData)data),
			new Person(), new DateTime(2014, 08, 04)));
		break;
	case (int)OneSData.Unit:
		oneSDbSet.Units.AddRange(GetDataFromOneS(DataHelper.GetStringValue((OneSData)data), new Unit(), new DateTime(2014, 08, 04)));
		break;
	case (int)OneSData.Employee:
		oneSDbSet.Employees.AddRange(GetDataFromOneS(DataHelper.GetStringValue((OneSData)data), new Employee(), DateTime.Now));
		break;
}
Приведенный номер типа OneSData, сравнивается с приведенными к целому StringValueAttribute а затем передается приведенный к типу OneSData параметр в 
GetDataFromOneS, который принимает просто тип StringValueAttribute, для последующего стучания к сервису , стучаземуся в  1"спаси и сохрани"С.
Как я понимаю это работает :  в любом случае запустим все три метода, создадутся стандартные инстансы объектов, 
при этом приведение к целому оказывается излишне. 



>>
Batch_1C_Orientdb.Intranet_POST и Batch_1C_Orientdb.Intranet_PUT ->
intranet_POST как создающий/инициализирующий 1С
intranet_PUT обновление из 1C,AD 
Сравниваются хеш записи Orient vs  1C ,апдейт найденных в Orient, запись новых из ненайденных



Различия
-------------------------------------------
ActiveDirectoryOrientDbEtl - > Ninject
AddressBook_News -> AutoFac



По общей логике
-------------------------------------------

ActiveDirectoryOrientDbEtl ->
	ActiveDirectoryOrientDBEtl.Contexts
		OrientDbContext ->
			1) претендент на отдельный проект можно вкрячить в нескоьлких проектах :
				[ActiveDirectoryOrientDbEtl,AddressBook_News, Batch_1C_Orientdb]
			2) далее , вокруг контекста можно накидать
За основу можно взять уже реализованую структуру из ActiveDirectoryOrientDbEtl (Person->PersonHelper->Context) 
и в AddressBook_backend.OrientHttpRestHelper
и в Batch_1C_Orientdb.Intranet_POST.OrientREST (это проекте, вообще уже почти модель и часть методов Repo готовы в Helpers)
а блок с batch можно напряму
а модель по принципу из AddressBook_backend.Models

/*
Repository {
	...
string OrientDbContext.Get<T>(int ID); where T: IOrientPOCO{...}
	...
}
*/

включив в него методы, которые частично пойдут из
	AddressBook_News.News_API.NewsAPI.Helpers.OrientNewsHelper,
	AddressBook_News.News_API.NewsAPI.Helpers.OrientDB_HttpManager,
	AddressBook_News.News_API.NewsAPI.Helpers.OrientDB_HttpManager
	ADBook_API.Helpers.OrientHelper.cs
Наиболее похожая аналогия Intranet.Models.IntranetHelper
так как не зависимо от приложения, в итоге мы кидаем в orient,
или команду sql  или параметр к процедуре черз API или те же параметры через драйвер.
Репозиторий оборачивается в UnitOfWork со всей бизнеслогикой.

/*
UnitOfWork {	
	...
Repository<Person>() EmployeeRepo;
Repository<Unit>() WorkPlaceRepo;
	...	
	sring GetAllPersonManagers(string AccountName_)
	{
		...
string EmployeeRepo.GetManagerByAccountName(AccountName_){...}
		...
	}
	...
}
*/

Общая линия сменится с
DB->(OrientNews)->(OrientDB_HttpManager/OrientNewsHelper/)->(ControllerWebAPI + Logic)
на 
DB->Repository->UnitOfWork->Model->(CntrollerWebAPI no Logic)



]

//OrientFuncts
[

//clortest
var g=orient.getGraph();
var b=g.command("sql","select DepartmentColorClass from (select expand( shortestPath((select from 
Unit where 
GUID = '00000000-0000-0000-0000-000000000000'), (select from VSC where GUID = '"+GUID+"'))[1]))");
return b;

var g=orient.getGraph();
var b=g.command("sql","select from entity where ID='"+ID+"'[1]");
//var b=g.command("sql","select from entity where ID=100");
return b;



//getallstructurefamily
var g=orient.getGraph();
var b=g.command("sql",
"select expand($c) let $v = (select from Unit where Name = 'НСПК'), 

$a = (select GUID as id,
ifnull(PGUID,'0'.asSet()) as parents,
Name as title,
Name as label,
' ' as phone,
Name as description,
'&nbsp' as mail, 
if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName , 
Birthday.format('dd.MM') as birthday 
from ( traverse in() from (SELECT dijkstra($current, $v, 
'SubUnit', 'both') FROM $v) whie $depth = 0 ) ), 

$b = ( select GUID as id, 
ifnull(if( eval(\"@class = 'Person'\"),in().GUID,PGUID.asSet()) ,'0'.asSet() ) as parents,
ifnull(telephoneNumber, ' ') as phone,
ifnull(mail,'&nbsp')as mail,
Name as title,
Name as label,
ifnull((inE('MainAssignment').Name[0]), Name) as description ,
if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName,
inE().State[0] as state,
if(eval('inE().ExpDate[0] is not null'),inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate  ,
Birthday.format('dd.MM') as birthday

from (
traverse out('MainAssignment','SubUnit') from
(select from Unit where Name = 'НСПК')
)
where (inE()[0].Disabled is null and Disabled is null) ), 

$c = unionall( $a, $b);");
return b;



//getallstructurelrgehty
var g=orient.getGraph();
var b=g.command("sql",
"select GUID as id, ifnull( if( eval(\"@class = 
'Person'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,'0' ) as parent,  ifnull(telephoneNumber, '
') as phone,
ifnull( mail,'&nbsp')as mail, Name as title, Name as label, ifnull((inE('MainAssignment').Name[0]),
Name) as description ,
GetDepartmentColor(GUID)[color][0] as itemTitleColor,
if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName,
inE().State[0] as state,
if( eval('inE().ExpDate[0] is not null'),
inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate  ,
Birthday.format('dd.MM') as birthday   
from (
traverse out('MainAssignment','SubUnit')
from (select from Unit where Name = 'НСПК')
)
where (
(inE()[0].Disabled is null and Disabled is null)
and (
(
(@class = 'Person') or 
(out(\"MainAssignment\").size() >0) or
(out(\"SubUnit\").size() >0)) or 
(Name = 'НСПК')
) and inE().State != 
\'ОтпускПоУходуЗаРебенком\' ) ");
return b;




//getartmentcolor
var g=orient.getGraph();
var b=g.command("sql",
"select $b.DepartmentColorRGB[0] as color

 let $a = (select if(eval('@class = \"Unit\"'),  GUID, 
 in('MainAssignment').GUID[0] ) 
 as GUID from (select from vsc where GUID = '"+GUID+"') ),
 
 $b = (	select DepartmentColorRGB 
 from (	select expand( shortestPath(
(select from Unit where GUID = '00000000-0000-0000-0000-000000000000'),
(select from VSC where GUID =  $a.GUID[0])
 )[1]))  
 )
 
 ");
return b;


//getartmentcolorclass
var g=orient.getGraph();
var b=g.command("sql","select $b.DepartmentColorClass[0] as colorClass 

let $a = (select 
if(eval('@class = 
\"Unit\"'), GUID, in('MainAssignment').GUID[0] ) as GUID from (select from vsc where GUID = 
'"+GUID+"') ), 
$b 
= (	select DepartmentColorClass from (	select expand(  shortestPath(  (select from Unit where GUID 
= 
'00000000-0000-0000-0000-000000000000') , (select from VSC where GUID =  $a.GUID[0] )   )[1]	)   
)  )");
return b;


//getdrmentname
var g=orient.getGraph();
var b=g.command("sql","select $b.Name[0] as departmentName let $a = (select if(eval('@class =
\"Unit\"'),
GUID, in('MainAssignment').GUID[0] ) as GUID from (select from vsc where GUID = '"+GUID+"') ), $b =
(select
Name from (	select expand(  shortestPath(  (select from Unit where GUID =
'00000000-0000-0000-0000-000000000000') , (select from VSC where GUID =  $a.GUID[0] ))[1])
))");
return b;


//getfirstlevelunits
var g=orient.getGraph();
var b=g.command("sql"," select from (traverse out(\"SubUnit\") from ( select from Unit where GUID = 
'00000000-0000-0000-0000-000000000000') while $depth <= 1) where Disabled is null ")
return b;


//getlarge
var g=orient.getGraph();
var b=g.command("sql","select GUID as id , ifnull( if( eval(\"@class = 
'Person'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,'0' ) as parent , ifnull(telephoneNumber, ' 
') as phone 
, ifnull( mail,'&nbsp')as mail , Name as title, Name as label   , 
ifnull((inE('MainAssignment').Name[0]), 
Name) as description   , GetDepartmentColor(GUID)[color][0] as itemTitleColor,
if(
eval(\"@class = 
'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName ,if(eval('inE().ExpDate[0] is 
not null'),
inE().State[0],null)  as state  ,  if( eval('inE().ExpDate[0] is not
null'),inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate,
GetPositionBar(InE().Name[0].replace('\\\"',''))['groupTitle'][0] as groupTitle,
Birthday.format('dd.MM') as 
birthday     
from  ( traverse out('MainAssignment','SubUnit') from (select from Unit where Name = 
'НСПК') ) 

where (
( inE()[0].Disabled is null and Disabled is null) 
and
(
((@class = 'Person') or (out(\"MainAssignment\").size() >0)  or (out(\"SubUnit\").size() >0)) 
or (Name = 'НСПК')
)

 and 
inE().State !=
\'ОтпускПоУходуЗаРебенком\' )");
return b;


(select from Unit where Name = 'НСПК')


//getperson
var g=orient.getGraph();
var b=g.command("sql",'select GetPersonPhoto(mail) as Photo, FirstName, GUID, PGUID 
,Name,Disabled,Created,sAMAccountName,Changed,LastName,MiddleName,mail,telephoneNumber,userAccountCon
trol,object
GUID from Person where GUID = "'+GUID+'"');
return b;

//get person photo
//var samaaa = mail.split('@')[0];
var link_s = 'http://msk1-vm-inapp01/AddressBookAPI/api/Photo/?email='+mail;
return link_s;


//var link_s = 'https:\/\/webmail.nspk.ru/ews/exchange.asmx/s/GetUserPhoto?email='
//var link_f = '&size=HR120x120'
//return link_s + mail + link_f;


//getposititonbar
var gr=orient.getGraph();
var br=gr.command("sql","
select $isDeputy['position'][0] as groupTitle

 let $managers = (select 
distinct(Name) 
as Name	from MainAssignment where ( (Name like '%уководите%' or Name like '%ачальни%' or Name like 
'%иректор%' or Name like '%аместите%')  and (not (Name like '%омощник%') and not (Name like 
'%екретар%') and 
not (Name like '%направлени%')) ) ) ,   

$isManager = (select if( 
eval(\"$managers.Name.indexOf('"+position+"') 
!= -1\"), 'true', 'false' ) as IsManager) , 

$IsZam = (select count(*) as IsZam from MainAssignment 
where Name 
= '"+position+"' and Name like '%Заместитель%') , 

$isDeputy = (select if( 
eval(\"$isManager['IsManager'][0] = 
true\"), if( eval(\"$IsZam[IsZam][0] > 0\") ,'Заместитель','Руководитель'), null) as position)");
return br;


//getstructure
var gr=orient.getGraph();
var br=gr.command("sql","select $isDeputy['position'][0] as groupTitle let $managers = (select 
distinct(Name) 
as Name	from MainAssignment where ( (Name like '%уководите%' or Name like '%ачальни%' or Name like 
'%иректор%' or Name like '%аместите%')  and (not (Name like '%омощник%') and not (Name like 
'%екретар%') and 
not (Name like '%направлени%')) ) ) ,   $isManager = (select if( 
eval(\"$managers.Name.indexOf('"+position+"') 
!= -1\"), 'true', 'false' ) as IsManager) , $IsZam = (select count(*) as IsZam from MainAssignment 
where Name 
= '"+position+"' and Name like '%Заместитель%') , $isDeputy = (select if( 
eval(\"$isManager['IsManager'][0] = 
true\"), if( eval(\"$IsZam[IsZam][0] > 0\") ,'Заместитель','Руководитель'), null) as position)");
return br;


//getstructurebypersonguid
var g=orient.getGraph();
var b=g.command("sql","select expand($c) let $v = (select expand( in('MainAssignment') ) from 
Person where 
GUID = '"+personGUID+"'), $a = (select GUID as id, ifnull(PGUID,0) as parent, Name as title, Name as 
label,'&nbsp' as phone, Name as description, '&nbsp' as mail, GetDepartmentColor(GUID)[color][0] as 
itemTitleColor,        if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as 
templateName  , 
Birthday.format('dd.MM') as birthday   ,  GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass  , 
GetWeight(InE('MainAssignment').Name[0].replace('\\\"',''))['value'][0] as weight , Seed as seed   
from ( 
traverse in() from  (      SELECT shortestPath( $v[0], (select from Unit where GUID = 
'00000000-0000-0000-0000-000000000000') )          ) while $depth  =0 ) ), $b = (select  GUID as 
id, ifnull( 
if( eval(\"@class = 'Person'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,'0' ) as parent,  
ifnull(telephoneNumber, ' ') as phone, ifnull( mail,'&nbsp')as mail, Name as title, Name as label, 
ifnull((inE('MainAssignment').Name[0]), Name) as description, GetDepartmentColor(GUID)[color][0] as 
itemTitleColor,  if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName 
,if(eval('inE().ExpDate[0] is not null'), inE().State[0],null)  as state,  if( 
eval('inE().ExpDate[0] is not 
null'),inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate, 
GetPositionBar(InE('MainAssignment').Name[0].replace('\\\"',''))['groupTitle'][0] as groupTitle   , 
Birthday.format('dd.MM') as birthday    ,  GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass  , 
GetWeight(InE('MainAssignment').Name[0].replace('\\\"',''))['value'][0] as weight , Seed as seed   
from ( 
traverse out('MainAssignment','SubUnit') from   	 $v[0] ) where 
((inE(\"MainAssignment\")[0].Disabled is 
null 
or inE(\"MainAssignment\")[0].Disabled >= sysdate() ) and (Disabled is null)  and ((@class = 
'Person') or 
(out(\"MainAssignment\").size() >0)  or (out(\"SubUnit\").size() >0)) or (Name = 'НСПК') ) and 
(inE().State != 
'Отпуск по уходу за ребенком' and inE().State != \'Отпуск по беременности и родам\' ) ), $c = 
unionall( $a, 
$b)");
return b;


//getstructurebypersonguid_
var g=orient.getGraph();
var b=g.command("sql","select  GUID as id      , ifnull( if( eval(\"@class = 
'Person'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,'0' ) as parent      ,  
ifnull(telephoneNumber, ' ') as 
phone      , ifnull( mail,' ')as mail      , Name as title      , Name as label      , 
ifnull((inE('MainAssignment').Name[0]), Name) as description      , 
GetDepartmentColor(GUID)[color][0] as 
itemTitleColor      , if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as 
templateName       
, if(eval('inE().ExpDate[0] is not null'), inE().State[0],null)  as state      , if( 
eval('inE().ExpDate[0] is 
not null'),inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate      , 
GetPositionBar(InE('MainAssignment').Name[0].replace('\\\"',''))['groupTitle'][0] as 
groupTitle         , 
Birthday.format('dd.MM') as birthday          , GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass        , GetWeight(InE('MainAssignment').Name[0].replace('\\\"',''))['value'][0] as 
weight , Seed 
as seed       		from ( select  expand( distinct(@this) ) from 
( 														select 
expand($c) 														let $v = (select expand( 
in('MainAssignment') 
) from Person where GUID = 
'53f45ea6-bcc2-11e4-ae8a-f80f41d3dd35'), 														$a 
= (select 
from ( traverse in() from  ( SELECT shortestPath(  $v, (select from Unit where GUID = 
'00000000-0000-0000-0000-000000000000') ) ) while $depth  =0 ) 
), 														$b = ( select from ( traverse 
out('MainAssignment','SubUnit') from $v ) where (( inE()[0].Disabled is null and Disabled is null) 
and 
((@class = 'Person') or (out(\"MainAssignment\").size() >0)  or (out(\"SubUnit\").size() >0)) or 
(Name = 
'НСПК') ) and inE().State != 'ОтпускПоУходуЗаРебенком' 
), 														$c = unionall( $a, 
$b)													)			)");
return b; 



//getstructurebysamaaccountname
var g=orient.getGraph();
var b=g.command("sql","select expand($c) let $v = (select expand( in('MainAssignment') ) from 
Person where 
sAMAccountName  = '"+sAMAccountName+"' ), $a = (select GUID as id, ifnull(PGUID,0) as parent, Name 
as title, 
Name as label,'&nbsp' as phone, Name as description, '&nbsp' as mail, 
GetDepartmentColor(GUID)[color][0] as 
itemTitleColor,        if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as 
templateName , 
Birthday.format('dd.MM') as birthday ,  GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass     from ( 
traverse in() from  (      SELECT shortestPath( $v, (select from Unit where GUID = 
'00000000-0000-0000-0000-000000000000') )          ) while $depth  =0 ) ), $b = (select  GUID as 
id, ifnull( 
if( eval(\"@class = 'Person'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,'0' ) as parent,  
ifnull(telephoneNumber, ' ') as phone, ifnull( mail,'&nbsp')as mail, Name as title, Name as label, 
ifnull((inE('MainAssignment').Name[0]), Name) as description, GetDepartmentColor(GUID)[color][0] as 
itemTitleColor,  if( eval(\"@class = 'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName 
,if(eval('inE().ExpDate[0] is not null'), inE().State[0],null)  as state,  if( 
eval('inE().ExpDate[0] is not 
null'),inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate, 
GetPositionBar(InE('MainAssignment').Name[0].replace('\\\"',''))['groupTitle'][0] as groupTitle  , 
Birthday.format('dd.MM') as birthday ,  GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass   from ( 
traverse out('MainAssignment','SubUnit') from   	 $v ) where (( inE()[0].Disabled is null and 
Disabled is 
null) and ((@class = 'Person') or (out(\"MainAssignment\").size() >0)  or (out(\"SubUnit\").size() 
>0)) or 
(Name = 'НСПК') ) and inE().State != 'ОтпускПоУходуЗаРебенком'  ), $c = unionall( $a, $b)");
return b;



//getstructurebyunitguid
var g=orient.getGraph();
var b=g.command("sql","select  GUID as id, ifnull( if( eval(\"@class = 
\'Person\'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,\'0\' ) as parent, ifnull(telephoneNumber, 
\' \') as 
phone, ifnull( mail,\'&nbsp\')as mail, Name as title, Name as label, 
ifnull((inE(\'MainAssignment\').Name[0]), 
Name) as description, GetDepartmentColor(GUID)[color][0] as itemTitleColor, if( eval(\"@class = 
\'Person\'\"),\'PersonTemplate\',\'UnitTemplate\' ) as templateName , if(eval(\'inE().ExpDate[0] is 
not 
null\'), inE().State[0],null)  as state, if( eval(\'inE().ExpDate[0] is not 
null\'),inE().ExpDate[0].format(\'dd.MM.YYYY\'),null) as expDate,  
GetPositionBar(InE('MainAssignment').Name[0].replace('\\\"',''))['groupTitle'][0] as groupTitle  , 
Birthday.format(\'dd.MM\') as birthday   ,  GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass  , 
GetWeight(InE('MainAssignment').Name[0].replace('\\\"',''))['value'][0] as weight    from ( traverse 
out(\'MainAssignment\',\'SubUnit\') from  (select from Unit where GUID = '"+UnitGUID+"' ) ) where 
((inE()[0].Disabled is null or inE()[0].Disabled >= sysdate() ) and (Disabled is null)  and ( 
((@class = 
\'Person\') or (out(\"MainAssignment\").size() >0)  or (out(\"SubUnit\").size() >0)) or (Name = 
\'НСПК\')) and 
(inE().State != \'Отпуск по уходу за ребенком\' and inE().State != \'Отпуск по беременности и 
родам\')   )  ");
return b;



//GetStructureByUnitGUIDAtCurrentLevel
var g=orient.getGraph();
var b=g.command("sql","select  GUID as id, ifnull( if( eval(\"@class = 
\'Person\'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,\'0\' ) as parent,ifnull(telephoneNumber, 
\' \') as 
phone, ifnull( mail,\'&nbsp\')as mail, Name as title, Name as label, 
ifnull((inE(\'MainAssignment\').Name[0]), 
Name) as description, GetDepartmentColor(GUID)[color][0] as itemTitleColor, if( eval(\"@class = 
\'Person\'\"),\'PersonTemplate\',\'UnitTemplate\' ) as templateName , if(eval(\'inE().ExpDate[0] is 
not 
null\'), inE().State[0],null)  as state, if( eval(\'inE().ExpDate[0] is not 
null\'),inE().ExpDate[0].format(\'dd.MM.YYYY\'),null) as expDate,  
GetPositionBar(InE('MainAssignment').Name[0].replace('\\\"',''))['groupTitle'][0] as groupTitle  , 
Birthday.format(\'dd.MM\') as birthday   ,  GetDepartmentColorClass(GUID)[colorClass][0] as 
colorClass  , 
GetWeight(InE('MainAssignment').Name[0].replace('\\\"',''))['value'][0] as weight , Seed as seed   
from ( 
traverse out(\'MainAssignment\',\'SubUnit\') from  (select from Unit where GUID = '"+UnitGUID+"' ) 
while 
$depth <=1 ) where ((inE()[0].Disabled is null or inE()[0].Disabled >= sysdate() ) and (Disabled is 
null)  and 
( ((@class = \'Person\') or (out(\"MainAssignment\").size() >0)  or (out(\"SubUnit\").size() >0)) 
or (Name = 
\'НСПК\')) and (inE().State != \'Отпуск по уходу за ребенком\' and inE().State != \'Отпуск по 
беременности и 
родам\')  )  ");
return b;



//GetStructureByUnitGUIDAtCurrentLevel
var gr=orient.getGraph();
if(position){
var br=gr.command("sql","

select $isDeputy['position'][0] as value

let $managers = 
(
select distinct(Name) as
Name	from MainAssignment where
(
(Name like '%уководите%' or Name like '%ачальни%' or Name like
'%иректор%'
or Name like '%аместите%')  and (not (Name like '%омощник%') and not (Name like '%екретар%') and
not (Name
like '%направлени%'))
)
),


$isManager = (select if( 
eval(\"$managers.Name.indexOf('"+position+"') != -1\"), 
'true', 'false' ) as IsManager) ,

$IsZam = (select count(*) as IsZam from MainAssignment where Name 
= '"+position+"' and Name like '%Заместитель%') , 

$isDeputy = (select if(
eval(\"$isManager['IsManager'][0] =
true\"), if( eval(\"$IsZam[IsZam][0] > 0\") ,1000000,0), 2000000) as position)


");
  return br;
}
else
{
  return 3000000;
}




//SearchByFNameLName
var g=orient.getGraph();
substr = substr.replace('ё','е').toUpperCase();
var b=g.command("sql","select expand($c) let $a = (select distinct(LastName).replace('ё','е') as 
suggestion 
from Person WHERE (LastName.replace('ё','е').toUpperCase() like '%"+substr+"%' ) and 
(inE()[0].Disabled is 
null or inE()[0].Disabled >= sysdate() ) and (Disabled is null)  and (inE().State != \'Отпуск по 
уходу за 
ребенком\' and inE().State != \'Отпуск по беременности и родам\' ) ), $b = (select 
distinct(FirstName).replace('ё','е') as suggestion from Person WHERE 
(FirstName.replace('ё','е').toUpperCase() 
like '%"+substr+"%' ) and  (inE()[0].Disabled is null or inE()[0].Disabled >= sysdate() ) and  
(Disabled is 
null) and (inE(\"MainAssignment\").State != \'Отпуск по уходу за ребенком\' and 
inE(\"MainAssignment\").State 
!= \'Отпуск по беременности и родам\' )),  $c = unionall($a,$b)");
return b;



//SearchByFNameLName_old
var g=orient.getGraph();
substr = substr.toUpperCase();
var b=g.command("sql","select expand($c) let $a = (select distinct(LastName) as lastName from 
Person WHERE 
LastName.toUpperCase() like '%"+substr+"%' and  inE()[0].Disabled is null and Disabled is null ), 
$b = (select 
distinct(FirstName) as lastName from Person WHERE FirstName.toUpperCase() like '%"+substr+"%' and  
inE()[0].Disabled is null and Disabled is null ), $c = unionall($a,$b)");
return b;



//SearchByLastName
var g=orient.getGraph();
substr = substr.toUpperCase();
var b=g.command("sql","select distinct(LastName) as lastName from Person WHERE 
LastName.toUpperCase() like
'%"+substr+"%' and  inE()[0].Disabled is null and Disabled is null ")
return b;



//SearchPerson
var g=orient.getGraph();
var b=g.command("sql","select GUID as id, ifnull( if( eval(\"@class = 
'Person'\"),in(\"MainAssignment\").Name[0],Name[0]) ,'0' ) as division , ifnull( if( eval(\"@class = 
'Person'\"),in(\"MainAssignment\").GUID[0],PGUID[0]) ,'0' ) as parent, ifnull(telephoneNumber, ' ')
as phone,
ifnull( mail,'&nbsp')as mail, Name as title, Name as label, ifnull((inE('MainAssignment').Name[0]), 
Name) as 
description , GetDepartmentColor(GUID)[color][0] as itemTitleColor , if( eval(\"@class = 
'Person'\"),'PersonTemplate','UnitTemplate' ) as templateName , if(eval('inE().ExpDate[0] is not 
null'), 
inE().State[0],null)  as state,  if( eval('inE().ExpDate[0] is not 
null'),inE().ExpDate[0].format('dd.MM.YYYY'),null) as expDate, 
GetPositionBar(InE().Name[0].replace('\\\"',''))['groupTitle'][0] as groupTitle  , 
Birthday.format('dd.MM') as 
birthday  ,  GetDepartmentColorClass(GUID)[colorClass][0] as colorClass, 
GetDepartmentName(GUID)[departmentName][0] as departmentName, sAMAccountName as login   from Person 
WHERE 
[Name, sAMAccountName] LUCENE /.*.*/  and (inE(\"MainAssignment\")[0].Disabled is 
null or 
inE(\"MainAssignment\")[0].Disabled >= sysdate() ) and (Disabled is null) and (inE().State != 
\'Отпуск по 
уходу за ребенком\' and inE().State != \'Отпуск по беременности и родам\' )");
return b;




]


[

	OrientNewsApi -> strange ActionResultExtensions.ExtractEntityId double call
	
]